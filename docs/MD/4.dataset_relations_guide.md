# Guide DÃ©taillÃ© : Relations et Jointures entre Datasets

## ğŸ¯ Objectif
Comprendre comment lier les donnÃ©es de **vols** avec les **conditions mÃ©tÃ©orologiques** en utilisant le dataset **wban_airport_timezone.csv** comme pont.

---

## ğŸ“Š Architecture des Relations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUX DE JOINTURE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    [Flights_samples.csv]
           â”‚
           â”‚ ORIGIN_AIRPORT_ID = 12478 (Ex: JFK)
           â”‚ DEST_AIRPORT_ID = 14107 (Ex: ORD)
           â”‚ FL_DATE = "2024-01-15"
           â”‚ CRS_DEP_TIME = 845 (08h45)
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  wban_airport_timezone.csv   â”‚  â† TABLE DE CORRESPONDANCE
    â”‚  AirportID â†’ WBAN â†’ TimeZone â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ AirportID = 12478 â†’ WBAN = 94789
           â”‚ TimeZone = -5 (UTC-5, EST)
           â†“
    [Weather_samples.csv]
           â”‚
           â”‚ WBAN = 94789
           â”‚ Date = 20240115
           â”‚ Time = 845
           â”‚ â†’ Conditions mÃ©tÃ©o de JFK Ã  08h45
```

---

## ğŸ” Ã‰tape 1 : Comprendre le rÃ´le du WBAN

### Qu'est-ce que le WBAN ?
**WBAN** = **W**eather **B**ureau **A**rmy **N**avy

- Code unique identifiant une **station mÃ©tÃ©orologique**
- Chaque aÃ©roport est associÃ© Ã  une (ou plusieurs) station(s) WBAN proche(s)
- C'est la **clÃ© de jointure** entre aÃ©roports et donnÃ©es mÃ©tÃ©o

### Exemple concret

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         wban_airport_timezone.csv                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AirportID    â”‚    WBAN     â”‚   TimeZone   â”‚  Airport Name  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  12478        â”‚   94789     â”‚      -5      â”‚  JFK (New York)â”‚
â”‚  14107        â”‚   94846     â”‚      -6      â”‚  ORD (Chicago) â”‚
â”‚  11292        â”‚   03927     â”‚      -8      â”‚  LAX (LA)      â”‚
â”‚  10397        â”‚   13874     â”‚      -5      â”‚  ATL (Atlanta) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**InterprÃ©tation :**
- L'aÃ©roport **JFK (ID 12478)** utilise la station mÃ©tÃ©o **WBAN 94789**
- Le fuseau horaire est **UTC-5** (Eastern Time)

---

## ğŸ”— Ã‰tape 2 : Jointure AÃ©roports â†” Stations MÃ©tÃ©o

### ScÃ©nario : Un vol de JFK Ã  Chicago

**DonnÃ©es du vol :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Flights_samples.csv                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FL_DATE  â”‚ CRS_DEP_TIMEâ”‚ORIGIN_AIRPORT_IDâ”‚ DEST_AIRPORT_ID    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚2024-01-15â”‚    845      â”‚     12478      â”‚       14107          â”‚
â”‚          â”‚  (08h45)    â”‚     (JFK)      â”‚       (ORD)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Jointure #1 : RÃ©cupÃ©rer le WBAN de l'aÃ©roport d'origine

```sql
SELECT 
    f.FL_DATE,
    f.CRS_DEP_TIME,
    f.ORIGIN_AIRPORT_ID,
    w.WBAN as ORIGIN_WBAN,
    w.TimeZone as ORIGIN_TIMEZONE
FROM Flights_samples f
LEFT JOIN wban_airport_timezone w
    ON f.ORIGIN_AIRPORT_ID = w.AirportID
```

**RÃ©sultat :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FL_DATE  â”‚CRS_DEP_TIME â”‚ORIGIN_AIRPORT_IDâ”‚ORIGIN_WBAN  â”‚ORIGIN_TIMEZONE â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚2024-01-15â”‚    845      â”‚     12478       â”‚   94789     â”‚      -5        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

âœ… **On a maintenant le code WBAN de la station mÃ©tÃ©o de JFK !**

---

## ğŸŒ¦ï¸ Ã‰tape 3 : Jointure avec les DonnÃ©es MÃ©tÃ©o

### DonnÃ©es mÃ©tÃ©o disponibles

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Weather_samples.csv                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ WBAN â”‚   Date   â”‚ Time â”‚DryBulbCelsius â”‚Visibilityâ”‚  SkyCondition â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚94789 â”‚20240115  â”‚ 800  â”‚      -2.0     â”‚   10.0   â”‚   CLR         â”‚
â”‚94789 â”‚20240115  â”‚ 845  â”‚      -1.5     â”‚    9.5   â”‚   SCT         â”‚
â”‚94789 â”‚20240115  â”‚ 900  â”‚      -1.0     â”‚    9.8   â”‚   SCT         â”‚
â”‚94846 â”‚20240115  â”‚ 830  â”‚      -5.0     â”‚    8.0   â”‚   OVC         â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Jointure #2 : Associer la mÃ©tÃ©o au vol

```sql
SELECT 
    f.FL_DATE,
    f.CRS_DEP_TIME,
    f.ORIGIN_AIRPORT_ID,
    w.DryBulbCelsius,
    w.Visibility,
    w.SkyCondition,
    w.WindSpeed,
    w.RelativeHumidity
FROM Flights_samples f
LEFT JOIN wban_airport_timezone wban
    ON f.ORIGIN_AIRPORT_ID = wban.AirportID
LEFT JOIN Weather_samples w
    ON wban.WBAN = w.WBAN
    AND CAST(f.FL_DATE AS INT) = w.Date
    AND f.CRS_DEP_TIME = w.Time
```

**RÃ©sultat final :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FL_DATE  â”‚CRS_DEP_TIME â”‚ORIGIN_AIRPORTâ”‚Temperature  â”‚Visibility â”‚SkyCondition â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚2024-01-15â”‚    845      â”‚   12478     â”‚    -1.5Â°C    â”‚   9.5 mi  â”‚    SCT      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

âœ… **On a les conditions mÃ©tÃ©o Ã  JFK au moment du dÃ©part !**

---

## âš ï¸ DÃ©fis de la Jointure Temporelle

### ProblÃ¨me 1 : Format des dates diffÃ©rent

```
Flights:  FL_DATE = "2024-01-15"  (String au format YYYY-MM-DD)
Weather:  Date = 20240115          (Integer au format YYYYMMDD)
```

**Solution Scala :**
```scala
// Convertir FL_DATE en format Integer
val flightsWithDate = flights.withColumn(
  "DATE_INT",
  regexp_replace(col("FL_DATE"), "-", "").cast(IntegerType)
)
```

### ProblÃ¨me 2 : Format des heures diffÃ©rent

```
Flights:  CRS_DEP_TIME = 845    (Integer : 8h45)
Weather:  Time = "0845"          (String : 08h45)
```

**Solution Scala :**
```scala
// Normaliser les heures au format 4 chiffres
val flightsWithTime = flights.withColumn(
  "TIME_NORMALIZED",
  lpad(col("CRS_DEP_TIME").cast(StringType), 4, "0")
)
```

### ProblÃ¨me 3 : Observations mÃ©tÃ©o manquantes

Les observations mÃ©tÃ©o sont **horaires**, mais les vols peuvent partir Ã  **n'importe quelle minute**.

**Exemple :**
- Vol dÃ©part prÃ©vu : **08h37**
- Observations mÃ©tÃ©o : 08h00, 08h30, 09h00
- âŒ Pas d'observation exacte Ã  08h37

**Solutions possibles :**

#### Option A : Observation la plus proche (avant le dÃ©part)
```scala
// Prendre la derniÃ¨re observation AVANT le dÃ©part
val weatherBeforeDeparture = weather.alias("w")
  .join(
    flights.alias("f"),
    col("w.WBAN") === col("f.ORIGIN_WBAN") &&
    col("w.Date") === col("f.DATE_INT") &&
    col("w.Time") <= col("f.TIME_NORMALIZED")
  )
  .groupBy("f.flight_id")
  .agg(max("w.Time").as("closest_time"))
```

#### Option B : FenÃªtre temporelle (Â±30 minutes)
```scala
// Prendre l'observation dans une fenÃªtre de 30 min
val windowedJoin = flights.join(
  weather,
  col("WBAN") === col("ORIGIN_WBAN") &&
  col("Date") === col("DATE_INT") &&
  abs(col("Time") - col("TIME_NORMALIZED")) <= 30
)
```

#### Option C : Interpolation linÃ©aire
```scala
// Moyenne pondÃ©rÃ©e entre observation avant et aprÃ¨s
// Plus complexe mais plus prÃ©cis
```

---

## ğŸ’» Code Scala Complet : Jointure pas Ã  pas

### Version 1 : Jointure Simple (exacte)

```scala
import org.apache.spark.sql.SparkSession
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types._

object FlightWeatherJoin {
  def main(args: Array[String]): Unit = {
    val spark = SparkSession.builder()
      .appName("Flight Weather Join")
      .master("local[*]")
      .getOrCreate()

    import spark.implicits._

    // 1. Charger les datasets
    val flights = spark.read
      .option("header", "true")
      .option("inferSchema", "true")
      .csv("Flights_samples.csv")

    val weather = spark.read
      .option("header", "true")
      .option("inferSchema", "true")
      .csv("Weather_samples.csv")

    val wbanMapping = spark.read
      .option("header", "true")
      .option("inferSchema", "true")
      .csv("wban_airport_timezone.csv")

    // 2. PrÃ©parer les donnÃ©es de vols
    val flightsPrepared = flights
      .filter(col("CANCELLED") === 0 && col("DIVERTED") === 0) // Filtrer vols annulÃ©s
      .withColumn("DATE_INT", 
        regexp_replace(col("FL_DATE"), "-", "").cast(IntegerType))
      .withColumn("TIME_NORMALIZED",
        lpad(col("CRS_DEP_TIME").cast(StringType), 4, "0"))

    // 3. Jointure #1 : Vols â†’ WBAN (Origine)
    val flightsWithOriginWBAN = flightsPrepared
      .join(
        wbanMapping.select(
          col("AirportID").as("ORIGIN_AIRPORT_ID"),
          col("WBAN").as("ORIGIN_WBAN"),
          col("TimeZone").as("ORIGIN_TIMEZONE")
        ),
        Seq("ORIGIN_AIRPORT_ID"),
        "left"
      )

    // 4. Jointure #2 : Vols â†’ MÃ©tÃ©o Origine
    val flightsWithOriginWeather = flightsWithOriginWBAN
      .join(
        weather.select(
          col("WBAN").as("ORIGIN_WBAN"),
          col("Date").as("WEATHER_DATE"),
          col("Time").as("WEATHER_TIME"),
          col("DryBulbCelsius").as("ORIGIN_TEMP"),
          col("RelativeHumidity").as("ORIGIN_HUMIDITY"),
          col("WindSpeed").as("ORIGIN_WIND"),
          col("Visibility").as("ORIGIN_VISIBILITY"),
          col("SkyCondition").as("ORIGIN_SKY"),
          col("HourlyPrecip").as("ORIGIN_PRECIP")
        ),
        col("ORIGIN_WBAN") === col("ORIGIN_WBAN") &&
        col("DATE_INT") === col("WEATHER_DATE") &&
        col("TIME_NORMALIZED") === col("WEATHER_TIME"),
        "left"
      )

    // 5. Optionnel : Jointure pour aÃ©roport de destination
    val flightsWithDestWBAN = flightsWithOriginWeather
      .join(
        wbanMapping.select(
          col("AirportID").as("DEST_AIRPORT_ID"),
          col("WBAN").as("DEST_WBAN")
        ),
        Seq("DEST_AIRPORT_ID"),
        "left"
      )

    // 6. Afficher le rÃ©sultat
    flightsWithDestWBAN.select(
      "FL_DATE",
      "CRS_DEP_TIME",
      "ORIGIN_AIRPORT_ID",
      "DEST_AIRPORT_ID",
      "ORIGIN_WBAN",
      "ORIGIN_TEMP",
      "ORIGIN_VISIBILITY",
      "ORIGIN_SKY",
      "ARR_DELAY_NEW"
    ).show(10)

    spark.stop()
  }
}
```

---

### Version 2 : Jointure avec FenÃªtre Temporelle

```scala
// Pour gÃ©rer les observations mÃ©tÃ©o manquantes
object FlightWeatherJoinWindowed {
  
  def joinWithTimeWindow(
    flights: DataFrame,
    weather: DataFrame,
    wbanMapping: DataFrame,
    windowMinutes: Int = 30
  ): DataFrame = {
    
    // PrÃ©parer les donnÃ©es
    val flightsPrepared = flights
      .withColumn("DATE_INT", 
        regexp_replace(col("FL_DATE"), "-", "").cast(IntegerType))
      .withColumn("DEP_TIME_MINUTES", 
        (col("CRS_DEP_TIME") / 100).cast(IntegerType) * 60 + 
        (col("CRS_DEP_TIME") % 100).cast(IntegerType)
      )
    
    val weatherPrepared = weather
      .withColumn("WEATHER_TIME_MINUTES",
        (col("Time").cast(IntegerType) / 100) * 60 +
        (col("Time").cast(IntegerType) % 100)
      )
    
    // Jointure avec WBAN
    val flightsWithWBAN = flightsPrepared
      .join(
        wbanMapping.select(
          col("AirportID").as("ORIGIN_AIRPORT_ID"),
          col("WBAN").as("ORIGIN_WBAN")
        ),
        Seq("ORIGIN_AIRPORT_ID"),
        "left"
      )
    
    // Jointure avec fenÃªtre temporelle
    val joined = flightsWithWBAN
      .join(
        weatherPrepared,
        col("ORIGIN_WBAN") === col("WBAN") &&
        col("DATE_INT") === col("Date") &&
        abs(col("DEP_TIME_MINUTES") - col("WEATHER_TIME_MINUTES")) <= windowMinutes,
        "left"
      )
      // Prendre l'observation la plus proche
      .withColumn("time_diff", 
        abs(col("DEP_TIME_MINUTES") - col("WEATHER_TIME_MINUTES")))
      .withColumn("rn",
        row_number().over(
          Window.partitionBy("FL_DATE", "OP_CARRIER_FL_NUM", "ORIGIN_AIRPORT_ID")
            .orderBy(col("time_diff"))
        )
      )
      .filter(col("rn") === 1)
      .drop("rn", "time_diff")
    
    joined
  }
}
```

---

## ğŸ“Š Exemple Complet avec RÃ©sultat

### DonnÃ©es d'entrÃ©e

**Flight :**
```
FL_DATE: 2024-01-15
CRS_DEP_TIME: 845
ORIGIN_AIRPORT_ID: 12478 (JFK)
DEST_AIRPORT_ID: 14107 (ORD)
ARR_DELAY_NEW: 23.0
```

**WBAN Mapping :**
```
AirportID: 12478 â†’ WBAN: 94789, TimeZone: -5
```

**Weather (station 94789, 2024-01-15) :**
```
Time: 0845
DryBulbCelsius: -1.5
RelativeHumidity: 75
WindSpeed: 15
Visibility: 9.5
SkyCondition: SCT
HourlyPrecip: 0.0
```

### DonnÃ©es de sortie (aprÃ¨s jointure)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FL_DATE  â”‚CRS_DEP_TIME â”‚ORIGIN_AIRPORTâ”‚ORIGIN_TEMPâ”‚VISIBILITYâ”‚WIND_SPEEDâ”‚HUMIDITYâ”‚ARR_DELAY_NEW â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚2024-01-15â”‚    845      â”‚    12478     â”‚  -1.5Â°C  â”‚  9.5 mi  â”‚  15 kts  â”‚  75%   â”‚    23.0      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

âœ… **Dataset prÃªt pour le Machine Learning !**

---

## ğŸ¯ RÃ©sumÃ© de la StratÃ©gie

1. **WBAN = Pont central** entre aÃ©roports et mÃ©tÃ©o
2. **Deux jointures successives** : Flights â†’ WBAN â†’ Weather
3. **Normalisation temporelle** : Convertir dates et heures au mÃªme format
4. **Gestion des manques** : FenÃªtre temporelle ou observation la plus proche
5. **Doubler la jointure** pour avoir la mÃ©tÃ©o Ã  l'origine ET Ã  la destination

---

## ğŸš€ Prochaines Ã‰tapes

Maintenant que vous comprenez la jointure, nous pouvons :

1. âœ… ImplÃ©menter le **preprocessing complet**
2. âœ… CrÃ©er le **feature engineering** (extraction de features temporelles)
3. âœ… Construire le **pipeline Spark ML**
4. âœ… EntraÃ®ner le **modÃ¨le de prÃ©diction**

Que voulez-vous implÃ©menter en premier ?